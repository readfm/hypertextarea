<div class='app a' id='editProfile'>
	<div class='column'>
		<div class='block' id='acc-me'>
			<div id='acc-avatar'></div>
			<input id='acc-fullName' name='fullName' class='transp' placeholder='Enter your full name'/>
			<textarea id='acc-intro' name='intro' class='transp'></textarea>

			<div id='acc-location'></div>
			<div id='acc-clickMessages'></div>

			<button id='acc-clickPublic'>View Public Profile</button>
		</div>


		<div class='block' id='acc-social'>
			<h2>
				Social Links
				<button class='o' id='acc-openNetworks'>+</button>
			</h2>
			<hr/>
			<div id='acc-socialLinks'></div>
			<div class='ifEmpty'>You have no social networks associated</div>
		</div>
	</div>

	<div class='column'>
		<div class='block' id='acc-about'>
			<h2>About Me</h2>
			<hr/>
			<textarea id='acc-about-text' class='transp' name='about'>
			Write a short description about yourself. The information you share on this page will only be shown to roperty owners and real estate agents if you show your explicit interest in their properties.
			</textarea>
		</div>

		<div class='block' id='acc-settings'>
			<h2>Account Settings</h2>
			<hr/>
			<form id='acc-sets' name='sets'>
				<div id='acc-setEmail'>
					<h3>Email</h3>
					<input class='transp' name='email' value='' placeholder='Enter your email'/>
				</div>

				<div id='acc-setPassword'>
					<h3>Password</h3>
					<h4 class='transp'>*************</h4>
				</div>


				<div id='acc-setPhone'>
					<h3>Phone</h3>
					<input class='transp' name='phone' value='' placeholder='Enter your phone number'/>
				</div>

				<div id='acc-setWork'>
					<h3>Work</h3>
					<input class='transp' name='work' value='' placeholder='Enter your work'/>
				</div>

				<div id='acc-setCompany'>
					<h3>Company</h3>
					<input class='transp' name='company' value='' placeholder='Enter your company name'/>
				</div>
			</form>

		</div>
	</div>

	<footer></footer>
</div>

<input id='uplBg' class='h' type="file" name="file"/>
<input id='uplAvatar' class='h' type="file" name="file"/>

<div class='tip' id='acc-tipPassword' style='width: 200px; margin-top: -8px'>
	<div class='tri'></div>
	Enter your new password
	<input id='acc-setPassword-p' type='password'/>
	Repeat it
	<input id='acc-setPassword-re' type='password'>
	<button id='acc-setPassword-ok' >OK</button>
	<span id='acc-setPassword-err' style='color: red'></span>
</div>

<div class='tip black' id='acc-addNetwork'>
	<div class="tri"></div>
	<a class='i-Gplus' title='Google+'></a>
	<a class='i-FB' title='Facebook'></a>
	<a class='i-in' title='LinkedIn'></a>
	<a class='i-twitter' title='Twitter'></a>
</div>

<script>
	window.editProfile = {
		sets: document.forms['acc-sets'],
		onOpen: function(){
			if(acc.user) editProfile.loadInfo(acc.user);
			else $('#editProfile').hide();
		},

		loadInfo: function(user){
			var $page = site.openApp('editProfile');
			var sets = editProfile.sets;

			sets.email.value = user.email || '';
			sets.phone.value = user.phone || '';
			sets.work.value = user.work || '';
			sets.company.value = user.company || '';
			document.getElementById('acc-fullName').value = user.fullName || '';
			document.getElementById('acc-intro').value = user.intro || '';
			document.getElementById('acc-about-text').value = user.about || '';

			var lifestyle = user.lifestyle || [];
			$('#acc-optionsLifestyle > .option > .bub').removeClass('v');
			$('#acc-optionsLifestyle > .option').each(function(){
				var name = $(this).data('cat') || $(this).text().toLowerCase().trim();

				if(lifestyle.indexOf(name)+1)
					$(this).children('.bub').addClass('v');
			});

			if(user.avatar)
				$('#acc-avatar').css('background-image', "url('/thumb/"+user.avatar+"')");

			$('#acc-socialLinks + .ifEmpty').show();
			console.log(user);
			if(user.networks)
				_.each(user.networks, function(profile, service){
					editProfile.addNetwork(profile, service);
				});
		},
		
		buildNetwork: function(profile, type){
			var button = document.createElement('button'),
				className = 'acc-social-'+type;
			button.classList.add(className);
			$('#acc-socialLinks > .'+className).remove();

			var link = profile.link;
			if(type == 'linkedin') link = profile.siteStandardProfileRequest.url;
			if(type == 'twitter') link = 'https://twitter.com/'+profile.screen_name;
			button.onclick = function(){
				window.open(link, '_blank');
			}
			return button;
		},

		addNetwork: function(profile, type){
			var button = editProfile.buildNetwork(profile, type);
			$('#acc-socialLinks').append(button).next('.ifEmpty').hide();
		}
	};

	(function(){
		editProfile.onOpen();
	})();


	$(function(){
		$('#acc-setPassword > h4').tip({
			pos: 'b',
			id: 'acc-tipPassword',
			event: 'click',
		});

		$('#acc-setPassword-ok').click(function(){
			var password = $('#acc-setPassword-p').val();
			if(password != $('#acc-setPassword-re').val())
				return $('#acc-setPassword-err').text('Must be the same');

			if(password.length < 5)
				return $('#acc-setPassword-err').text('Too short');


			$('#acc-setPassword > h4').text(password.replace(/(\w)/g, '*')).blink('green');
			ws.send({
				cmd: 'changePassword',
				password: password 
			});
			tip.hide();
		});



		$('#acc-password-report').text('');

		var sets = editProfile.sets,
			cb = function(ev){
				var set = {};
				if(ev && ev.target){
					set[ev.target.name] = ev.target.value;
					$(ev.target).blink('green');
				}
				else{
					set[this.name] =this.value
					$(this).blink('green');
				}

				_.extend(acc.user, set);

				ws.send({
					cmd: 'updateProfile',
					set: set
				});

			};

		$('#acc-fullName, #acc-intro, #acc-about-text').add(sets.email).add(sets.phone).add(sets.work).add(sets.company)
		.change(cb).bindEnter(cb);



		$('#acc-avatar').click(function(){
			$('#uplAvatar').click();
		});

		$('#uplAvatar').bind('change', function(evt){
			evt.preventDefault();
			
			var files = (evt.target.files || evt.dataTransfer.files);
			if(!files) return false;
			var f = files[0];

			if(!f.type.match('image.*')) return;

			$.ajax('/', {
				data: f,
				processData: false,
				success: function(r){
					if(!r.file) return;
					var fid = r.file.id;

					if(fid) img.generateImage(f, function(image){
						img.saveThumb(image, function(thumbName){
							ws.send({
								cmd: 'updateProfile',
								set: {avatar: fid}
							});

							$('#avatar,#acc-avatar').css('background-image', 'url(/thumb/'+fid+')');
						}, fid);
					});
				},
				complete: function(){
					//$('#avatar').cc();
				},
				type: 'PUT'
			});
		});

		$('#acc-openNetworks').tip({
			pos: 'b',
			id: 'acc-addNetwork',
			fix: 'c',
			event: 'click',
			on: function(cfg){

			}
		});

		ws.on.newNetwork = function(m){
			if(!m.profile) return;
			var set = {};
			set['networks.'+m.service] = m.profile
			ws.send({
				cmd: 'updateProfile',
				set: set
			});

			editProfile.addNetwork(m.profile, m.service);
		}

		$('#acc-addNetwork > a').click(function(){
			var network;

			if($(this).hasClass('i-Gplus')) network = 'google';
			if($(this).hasClass('i-FB')) network = 'facebook';
			if($(this).hasClass('i-in')) network = 'linkedin';
			if($(this).hasClass('i-twitter')) network = 'twitter';

			ws.send({
				cb: cb
			}, function(r){
				if(r.info){
					console.log(r.info);
				}
			});

			window.open('http://'+domain+'/auth/'+network, '_blank', {
				height: 200,
				width: 300,
				status: false
			});
		});
	});
</script>